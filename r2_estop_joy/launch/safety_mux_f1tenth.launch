<launch>
  <!--
    ROSMASTER R2 - Safety + FTG add-on (Yahboom compatible)

    IMPORTANT:
    - Do NOT start twist_mux here.
      yahboomcar_nav/laser_bringup.launch already starts twist_mux and owns /cmd_vel.
    - This file only produces:
        /pp_enable
        /cmd_vel_auto
        /cmd_vel_ftg_raw
        /cmd_vel_safety
  -->

  <arg name="scan_topic" default="/scan"/>
  <arg name="mode" default="switch"/>             <!-- switch | blend -->
  <arg name="enable_button" default="4"/>         <!-- your PP deadman (R1 in your logs) -->
  <arg name="estop_button" default="3"/>          <!-- your E-stop button -->

  <!-- Deadman enable: publishes /pp_enable True only while enable_button is held -->
  <node pkg="r2_estop_joy" type="mode_hold.py" name="mode_hold" output="screen">
    <param name="joy_topic" value="/joy"/>
    <param name="enable_button" value="$(arg enable_button)"/>
    <param name="topic" value="/pp_enable"/>
    <param name="rate_hz" value="30"/>
  </node>

  <!-- SIMPLE E-STOP (no twist_mux_msgs/Lock needed)
       Publishes ZERO Twist on /cmd_vel_safety while estop button is held.
       Since yahboom twist_mux subscribes to /cmd_vel_safety at high priority, this stops the car.
  -->
  <node pkg="r2_estop_joy" type="joy_estop_zero.py" name="joy_estop_zero" output="screen">
    <param name="joy_topic" value="/joy"/>
    <param name="estop_button" value="$(arg estop_button)"/>
    <param name="out_topic" value="/cmd_vel_safety"/>
    <param name="rate_hz" value="30"/>
    <param name="hold_mode" value="true"/>   <!-- stop while held -->
  </node>

  <!-- Gate PP output: only passes /cmd_vel_auto_raw while /pp_enable is True
       Output is /cmd_vel_auto (Yahboom's cmd_vel_auto_gate will then create /cmd_vel_auto_gated)
  -->
  <node pkg="r2_raceline_pp" type="cmdvel_gate.py" name="cmdvel_gate" output="screen">
    <param name="enable_topic" value="/pp_enable"/>
    <param name="in_topic" value="/cmd_vel_auto_raw"/>
    <param name="out_topic" value="/cmd_vel_auto"/>
    <param name="publish_zero_when_disabled" value="true"/>
    <param name="rate_hz" value="30"/>
  </node>

  <!-- REAL FTG controller -->
  <node pkg="r2_ftg_safety" type="ftg_f1tenth_node.py" name="ftg_f1tenth" output="screen">
    <rosparam command="load" file="$(find r2_ftg_safety)/config/ftg_f1tenth.yaml"/>
    <param name="scan_topic" value="$(arg scan_topic)"/>
    <param name="out_topic" value="/cmd_vel_ftg_raw"/>
  </node>

  <!-- Auto takeover / blend -> publishes /cmd_vel_safety (highest priority into yahboom twist_mux) -->
  <node pkg="r2_ftg_safety" type="ftg_auto_switch_node.py" name="ftg_auto_switch" output="screen">
    <rosparam command="load" file="$(find r2_ftg_safety)/config/ftg_auto_switch.yaml"/>
    <param name="mode" value="$(arg mode)"/>
    <param name="scan_topic" value="$(arg scan_topic)"/>
    <param name="enable_topic" value="/pp_enable"/>

    <param name="pp_cmd_topic" value="/cmd_vel_auto"/>
    <param name="ftg_cmd_topic" value="/cmd_vel_ftg_raw"/>
    <param name="out_cmd_topic" value="/cmd_vel_safety"/>
  </node>

</launch>

